# Build, Test and Deploy (Single Environment) - Trigger Run

on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - '**.md'
      - 'LICENSE'
      - '.gitignore'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: bqnow/testshop

jobs:
  # 1. Build: Baut das Docker-Image für das Playwright-Template
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

  # 2. Test: Führt E2E-Tests aus (Überspringbar via GitHub Variable SKIP_E2E)
  test:
    needs: build
    if: vars.SKIP_E2E != 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout E2E Framework
        uses: actions/checkout@v4
        with:
          repository: bqnow/testshop-playwright-template
          token: ${{ secrets.GH_PAT_TRIGGER }}
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Run E2E Tests
        env:
          BASE_URL: https://testshop-dusky.vercel.app
          SHOP_IMAGE_TAG: latest
          TEST_USER_NAME: ${{ secrets.TEST_USER_NAME }}
          TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
        run: docker compose up --build --exit-code-from playwright

  # 3. Deploy: Erst wenn Tests grün (oder übersprungen) sind, wird zu Vercel gepusht
  deploy:
    needs: test
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod' # Deployt auf die einzige Live-Umgebung
          working-directory: ./
