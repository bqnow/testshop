name: Build, Test and Deploy (Gated Pipeline)

on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - '**.md'
      - 'LICENSE'
      - '.gitignore'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: bqnow/testshop

jobs:
  # 1. Build: Baut das Docker-Image für die Applikation (Shop)
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

  # 2. Test: Führt E2E-Tests aus (Überspringbar via GitHub Variable SKIP_E2E)
  test:
    needs: build
    if: vars.SKIP_E2E != 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout E2E Framework
        uses: actions/checkout@v4
        with:
          repository: bqnow/testshop-playwright-typescript-template
          token: ${{ secrets.GH_PAT_TRIGGER }}
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Run E2E Tests
        env:
          BASE_URL: http://app:3000
          SHOP_IMAGE_TAG: latest
          TEST_ENV: ci_gated_pipeline
          TEST_USER_NAME: ${{ secrets.TEST_USER_NAME }}
          TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
          GRAFANA_LOKI_URL: ${{ secrets.GRAFANA_LOKI_URL }}
          GRAFANA_LOKI_USER: ${{ secrets.GRAFANA_LOKI_USER }}
          GRAFANA_LOKI_KEY: ${{ secrets.GRAFANA_LOKI_KEY }}
        run: docker compose up --build --exit-code-from playwright

      - name: Upload Playwright Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: reporting/
          retention-days: 7

  # 3. Performance Test: Führt JMeter Belastungstests aus
  performance-test:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Shop App (for Docker Compose)
        uses: actions/checkout@v4

      - name: Checkout JMeter Framework
        uses: actions/checkout@v4
        with:
          repository: bqnow/testshop-performance-jmeter
          path: jmeter-tests
          # Falls das Repo privat ist, TOKEN nutzen. Hier gehen wir von Public oder PAT aus.
          token: ${{ secrets.GH_PAT_TRIGGER || github.token }}

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Start Shop App
        run: |
          docker compose up -d
          # Warten bis die App gesund ist (siehe healthcheck in compose)
          timeout 60s bash -c 'until [ "$(docker inspect -f {{.State.Health.Status}} testshop-app-1)" == "healthy" ]; do sleep 2; done'

      - name: Run JMeter Tests
        run: |
          chmod +x jmeter-tests/scripts/run_test.sh
          # Wir führen JMeter in einem Docker-Container aus, damit wir keine Java/JMeter Installation auf dem Runner brauchen
          docker run --rm \
            --network host \
            -v ${{ github.workspace }}/jmeter-tests:/tests \
            justb4/jmeter:5.6.3 \
            -n -t /tests/jmx/smoketestjmx.jmx \
            -l /tests/results/result.jtl \
            -e -o /tests/results/report \
            -JHOST=localhost -JPORT=3000

      - name: Upload JMeter Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: jmeter-report
          path: jmeter-tests/results/report/
          retention-days: 7

  # 4. Deploy: Erst wenn E2E UND Performance Tests grün sind (oder skipped), wird zu Vercel gepusht
  deploy:
    needs: [test, performance-test]
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped') && (needs.performance-test.result == 'success' || needs.performance-test.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          working-directory: ./
